#include "utils/utils.h"
#include "des/des.h"

static const uint8_t rots[16] =
{
	1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1,
};

static const uint8_t pc1[56] =
{
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09, 0x01,
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x3B, 0x33, 0x2B, 0x23, 0x1B, 0x13, 0x0B, 0x03,
	0x3C, 0x34, 0x2C, 0x24, 0x3F, 0x37, 0x2F, 0x27,
	0x1F, 0x17, 0x0F, 0x07, 0x3E, 0x36, 0x2E, 0x26,
	0x1E, 0x16, 0x0E, 0x06, 0x3D, 0x35, 0x2D, 0x25,
	0x1D, 0x15, 0x0D, 0x05, 0x1C, 0x14, 0x0C, 0x04,
};

static const uint8_t pc2[48] =
{
	0x0E, 0x11, 0x0B, 0x18, 0x01, 0x05, 0x03, 0x1C,
	0x0F, 0x06, 0x15, 0x0A, 0x17, 0x13, 0x0C, 0x04,
	0x1A, 0x08, 0x10, 0x07, 0x1B, 0x14, 0x0D, 0x02,
	0x29, 0x34, 0x1F, 0x25, 0x2F, 0x37, 0x1E, 0x28,
	0x33, 0x2D, 0x21, 0x30, 0x2C, 0x31, 0x27, 0x38,
	0x22, 0x35, 0x2E, 0x2A, 0x32, 0x24, 0x1D, 0x20,
};

static const uint8_t ip[64] =
{
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x3C, 0x34, 0x2C, 0x24, 0x1C, 0x14, 0x0C, 0x04,
	0x3E, 0x36, 0x2E, 0x26, 0x1E, 0x16, 0x0E, 0x06,
	0x40, 0x38, 0x30, 0x28, 0x20, 0x18, 0x10, 0x08,
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09, 0x01,
	0x3B, 0x33, 0x2B, 0x23, 0x1B, 0x13, 0x0B, 0x03,
	0x3D, 0x35, 0x2D, 0x25, 0x1D, 0x15, 0x0D, 0x05,
	0x3F, 0x37, 0x2F, 0x27, 0x1F, 0x17, 0x0F, 0x07,
};

static const uint8_t ip1[64] =
{
	0x28, 0x08, 0x30, 0x10, 0x38, 0x18, 0x40, 0x20,
	0x27, 0x07, 0x2F, 0x0F, 0x37, 0x17, 0x3F, 0x1F,
	0x26, 0x06, 0x2E, 0x0E, 0x36, 0x16, 0x3E, 0x1E,
	0x25, 0x05, 0x2D, 0x0D, 0x35, 0x15, 0x3D, 0x1D,
	0x24, 0x04, 0x2C, 0x0C, 0x34, 0x14, 0x3C, 0x1C,
	0x23, 0x03, 0x2B, 0x0B, 0x33, 0x13, 0x3B, 0x1B,
	0x22, 0x02, 0x2A, 0x0A, 0x32, 0x12, 0x3A, 0x1A,
	0x21, 0x01, 0x29, 0x09, 0x31, 0x11, 0x39, 0x19,
};

static const uint8_t e[48] =
{
	0x20, 0x01, 0x02, 0x03, 0x04, 0x05, 0x04, 0x05,
	0x06, 0x07, 0x08, 0x09, 0x08, 0x09, 0x0A, 0x0B,
	0x0C, 0x0D, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x14, 0x15,
	0x16, 0x17, 0x18, 0x19, 0x18, 0x19, 0x1A, 0x1B,
	0x1C, 0x1D, 0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x01,
};

static const uint8_t p[32] =
{
	0x10, 0x07, 0x14, 0x15, 0x1D, 0x0C, 0x1C, 0x11,
	0x01, 0x0F, 0x17, 0x1A, 0x05, 0x12, 0x1F, 0x0A,
	0x02, 0x08, 0x18, 0x0E, 0x20, 0x1B, 0x03, 0x09,
	0x13, 0x0D, 0x1E, 0x06, 0x16, 0x0B, 0x04, 0x19,
};

static const uint8_t ss[8][64] =
{
	{
		0xE, 0x4, 0xD, 0x1, 0x2, 0xF, 0xB, 0x8,
		0x3, 0xA, 0x6, 0xC, 0x5, 0x9, 0x0, 0x7,
		0x0, 0xF, 0x7, 0x4, 0xE, 0x2, 0xD, 0x1,
		0xA, 0x6, 0xC, 0xB, 0x9, 0x5, 0x3, 0x8,
		0x4, 0x1, 0xE, 0x8, 0xD, 0x6, 0x2, 0xB,
		0xF, 0xC, 0x9, 0x7, 0x3, 0xA, 0x5, 0x0,
		0xF, 0xC, 0x8, 0x2, 0x4, 0x9, 0x1, 0x7,
		0x5, 0xB, 0x3, 0xE, 0xA, 0x0, 0x6, 0xD,
	},
	{
		0xF, 0x1, 0x8, 0xE, 0x6, 0xB, 0x3, 0x4,
		0x9, 0x7, 0x2, 0xD, 0xC, 0x0, 0x5, 0xA,
		0x3, 0xD, 0x4, 0x7, 0xF, 0x2, 0x8, 0xE,
		0xC, 0x0, 0x1, 0xA, 0x6, 0x9, 0xB, 0x5,
		0x0, 0xE, 0x7, 0xB, 0xA, 0x4, 0xD, 0x1,
		0x5, 0x8, 0xC, 0x6, 0x9, 0x3, 0x2, 0xF,
		0xD, 0x8, 0xA, 0x1, 0x3, 0xF, 0x4, 0x2,
		0xB, 0x6, 0x7, 0xC, 0x0, 0x5, 0xE, 0x9,
	},
	{
		0xA, 0x0, 0x9, 0xE, 0x6, 0x3, 0xF, 0x5,
		0x1, 0xD, 0xC, 0x7, 0xB, 0x4, 0x2, 0x8,
		0xD, 0x7, 0x0, 0x9, 0x3, 0x4, 0x6, 0xA,
		0x2, 0x8, 0x5, 0xE, 0xC, 0xB, 0xF, 0x1,
		0xD, 0x6, 0x4, 0x9, 0x8, 0xF, 0x3, 0x0,
		0xB, 0x1, 0x2, 0xC, 0x5, 0xA, 0xE, 0x7,
		0x1, 0xA, 0xD, 0x0, 0x6, 0x9, 0x8, 0x7,
		0x4, 0xF, 0xE, 0x3, 0xB, 0x5, 0x2, 0xC,
	},
	{
		0x7, 0xD, 0xE, 0x3, 0x0, 0x6, 0x9, 0xA,
		0x1, 0x2, 0x8, 0x5, 0xB, 0xC, 0x4, 0xF,
		0xD, 0x8, 0xB, 0x5, 0x6, 0xF, 0x0, 0x3,
		0x4, 0x7, 0x2, 0xC, 0x1, 0xA, 0xE, 0x9,
		0xA, 0x6, 0x9, 0x0, 0xC, 0xB, 0x7, 0xD,
		0xF, 0x1, 0x3, 0xE, 0x5, 0x2, 0x8, 0x4,
		0x3, 0xF, 0x0, 0x6, 0xA, 0x1, 0xD, 0x8,
		0x9, 0x4, 0x5, 0xB, 0xC, 0x7, 0x2, 0xE,
	},
	{
		0x2, 0xC, 0x4, 0x1, 0x7, 0xA, 0xB, 0x6,
		0x8, 0x5, 0x3, 0xF, 0xD, 0x0, 0xE, 0x9,
		0xE, 0xB, 0x2, 0xC, 0x4, 0x7, 0xD, 0x1,
		0x5, 0x0, 0xF, 0xA, 0x3, 0x9, 0x8, 0x6,
		0x4, 0x2, 0x1, 0xB, 0xA, 0xD, 0x7, 0x8,
		0xF, 0x9, 0xC, 0x5, 0x6, 0x3, 0x0, 0xE,
		0xB, 0x8, 0xC, 0x7, 0x1, 0xE, 0x2, 0xD,
		0x6, 0xF, 0x0, 0x9, 0xA, 0x4, 0x5, 0x3,
	},
	{
		0xC, 0x1, 0xA, 0xF, 0x9, 0x2, 0x6, 0x8,
		0x0, 0xD, 0x3, 0x4, 0xE, 0x7, 0x5, 0xB,
		0xA, 0xF, 0x4, 0x2, 0x7, 0xC, 0x9, 0x5,
		0x6, 0x1, 0xD, 0xE, 0x0, 0xB, 0x3, 0x8,
		0x9, 0xE, 0xF, 0x5, 0x2, 0x8, 0xC, 0x3,
		0x7, 0x0, 0x4, 0xA, 0x1, 0xD, 0xB, 0x6,
		0x4, 0x3, 0x2, 0xC, 0x9, 0x5, 0xF, 0xA,
		0xB, 0xE, 0x1, 0x7, 0x6, 0x0, 0x8, 0xD,
	},
	{
		0x4, 0xB, 0x2, 0xE, 0xF, 0x0, 0x8, 0xD,
		0x3, 0xC, 0x9, 0x7, 0x5, 0xA, 0x6, 0x1,
		0xD, 0x0, 0xB, 0x7, 0x4, 0x9, 0x1, 0xA,
		0xE, 0x3, 0x5, 0xC, 0x2, 0xF, 0x8, 0x6,
		0x1, 0x4, 0xB, 0xD, 0xC, 0x3, 0x7, 0xE,
		0xA, 0xF, 0x6, 0x8, 0x0, 0x5, 0x9, 0x2,
		0x6, 0xB, 0xD, 0x8, 0x1, 0x4, 0xA, 0x7,
		0x9, 0x5, 0x0, 0xF, 0xE, 0x2, 0x3, 0xC,
	},
	{
		0xD, 0x2, 0x8, 0x4, 0x6, 0xF, 0xB, 0x1,
		0xA, 0x9, 0x3, 0xE, 0x5, 0x0, 0xC, 0x7,
		0x1, 0xF, 0xD, 0x8, 0xA, 0x3, 0x7, 0x4,
		0xC, 0x5, 0x6, 0xB, 0x0, 0xE, 0x9, 0x2,
		0x7, 0xB, 0x4, 0x1, 0x9, 0xC, 0xE, 0x2,
		0x0, 0x6, 0xA, 0xD, 0xF, 0x3, 0x5, 0x8,
		0x2, 0x1, 0xE, 0x7, 0x4, 0xA, 0x8, 0xD,
		0xF, 0xC, 0x9, 0x0, 0x3, 0x5, 0x6, 0xB,
	}
};

static uint64_t permute(uint64_t src, const uint8_t *table,
                        uint8_t out_len, uint8_t in_len)
{
	uint64_t result = 0;
	for (size_t i = 0; i < out_len; ++i)
		result |= ((src >> ((in_len - 1) - (table[i] - 1))) & 1) << ((out_len - 1) - i);
	return result;
}

void des_generate_keys(struct des_ctx *ctx, const uint8_t *key)
{
	uint32_t c[16];
	uint32_t d[16];
	uint64_t dst = permute(be64dec(key), pc1, 56, 64);
	c[0] = rol28((dst & 0xFFFFFFF0000000) >> 28, rots[0]);
	d[0] = rol28(dst & 0xFFFFFFF, rots[0]);
	for (size_t i = 1; i < 16; ++i)
	{
		c[i] = rol28(c[i - 1], rots[i]);
		d[i] = rol28(d[i - 1], rots[i]);
	}
	for (size_t i = 0; i < 16; ++i)
	{
		uint64_t tmp = (uint64_t)d[i] | ((uint64_t)c[i] << 28);
		ctx->keys[i] = permute(tmp, pc2, 48, 56);
	}
}

static uint32_t f(uint32_t r, uint64_t key)
{
	uint64_t tmp = permute(r, e, 48, 32);
	tmp ^= key;
	uint32_t res = 0;
	for (size_t i = 0; i < 8; ++i)
	{
		uint8_t s = (tmp >> (6 * (7 - i))) & 0x3F;
		s = ss[i][((s & 0x20) | ((s & 1) << 4)) + ((s >> 1) & 0xF)];
		res |= s << ((7 - i) * 4);
	}
	return permute(res, p, 32, 32);
}

void des_operate_block(struct des_ctx *ctx, uint8_t *out, const uint8_t *in,
                       int enc)
{
	uint32_t l[16];
	uint32_t r[16];
	uint64_t tmp = be64dec(in);
	tmp = permute(tmp, ip, 64, 64);
	l[0] = tmp;
	r[0] = (tmp >> 32) ^ f(l[0], ctx->keys[enc ? 0 : 15]);
	for (size_t i = 1; i < 16; ++i)
	{
		l[i] = r[i - 1];
		r[i] = l[i - 1] ^ f(r[i - 1], ctx->keys[enc ? i : 15 - i]);
	}
	tmp = ((uint64_t)r[15] << 32) | (uint64_t)l[15];
	be64enc(out, permute(tmp, ip1, 64, 64));
}
