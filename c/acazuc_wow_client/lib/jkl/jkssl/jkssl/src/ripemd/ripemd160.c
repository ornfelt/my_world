#include "ripemd/ripemd.h"
#include "utils/utils.h"

#include <string.h>

static const uint8_t g[160] =
{
	0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7,
	0x8, 0x9, 0xA, 0xB, 0xC, 0xD, 0xE, 0xF,
	0x7, 0x4, 0xD, 0x1, 0xA, 0x6, 0xF, 0x3,
	0xC, 0x0, 0x9, 0x5, 0x2, 0xE, 0xB, 0x8,
	0x3, 0xA, 0xE, 0x4, 0x9, 0xF, 0x8, 0x1,
	0x2, 0x7, 0x0, 0x6, 0xD, 0xB, 0x5, 0xC,
	0x1, 0x9, 0xB, 0xA, 0x0, 0x8, 0xC, 0x4,
	0xD, 0x3, 0x7, 0xF, 0xE, 0x5, 0x6, 0x2,
	0x4, 0x0, 0x5, 0x9, 0x7, 0xC, 0x2, 0xA,
	0xE, 0x1, 0x3, 0x8, 0xB, 0x6, 0xF, 0xD,
	0x5, 0xE, 0x7, 0x0, 0x9, 0x2, 0xB, 0x4,
	0xD, 0x6, 0xF, 0x8, 0x1, 0xA, 0x3, 0xC,
	0x6, 0xB, 0x3, 0x7, 0x0, 0xD, 0x5, 0xA,
	0xE, 0xF, 0x8, 0xC, 0x4, 0x9, 0x1, 0x2,
	0xF, 0x5, 0x1, 0x3, 0x7, 0xE, 0x6, 0x9,
	0xB, 0x8, 0xC, 0x2, 0xA, 0x0, 0x4, 0xD,
	0x8, 0x6, 0x4, 0x1, 0x3, 0xB, 0xF, 0x0,
	0x5, 0xC, 0x2, 0xD, 0x9, 0x7, 0xA, 0xE,
	0xC, 0xF, 0xA, 0x4, 0x1, 0x5, 0x8, 0x7,
	0x6, 0x2, 0xD, 0xE, 0x0, 0x3, 0x9, 0xB,
};

static const uint8_t s[160] =
{
	0xB, 0xE, 0xF, 0xC, 0x5, 0x8, 0x7, 0x9,
	0xB, 0xD, 0xE, 0xF, 0x6, 0x7, 0x9, 0x8,
	0x7, 0x6, 0x8, 0xD, 0xB, 0x9, 0x7, 0xF,
	0x7, 0xC, 0xF, 0x9, 0xB, 0x7, 0xD, 0xC,
	0xB, 0xD, 0x6, 0x7, 0xE, 0x9, 0xD, 0xF,
	0xE, 0x8, 0xD, 0x6, 0x5, 0xC, 0x7, 0x5,
	0xB, 0xC, 0xE, 0xF, 0xE, 0xF, 0x9, 0x8,
	0x9, 0xE, 0x5, 0x6, 0x8, 0x6, 0x5, 0xC,
	0x9, 0xF, 0x5, 0xB, 0x6, 0x8, 0xD, 0xC,
	0x5, 0xC, 0xD, 0xE, 0xB, 0x8, 0x5, 0x6,
	0x8, 0x9, 0x9, 0xB, 0xD, 0xF, 0xF, 0x5,
	0x7, 0x7, 0x8, 0xB, 0xE, 0xE, 0xC, 0x6,
	0x9, 0xD, 0xF, 0x7, 0xC, 0x8, 0x9, 0xB,
	0x7, 0x7, 0xC, 0x7, 0x6, 0xF, 0xD, 0xB,
	0x9, 0x7, 0xF, 0xB, 0x8, 0x6, 0x6, 0xE,
	0xC, 0xD, 0x5, 0xE, 0xD, 0xD, 0x7, 0x5,
	0xF, 0x5, 0x8, 0xB, 0xE, 0xE, 0x6, 0xE,
	0x6, 0x9, 0xC, 0x9, 0xC, 0x5, 0xF, 0x8,
	0x8, 0x5, 0xC, 0x9, 0xC, 0x5, 0xE, 0x6,
	0x8, 0xD, 0x6, 0x5, 0xF, 0xD, 0xB, 0xB,
};

static const uint32_t k[10] =
{
	0x00000000, 0x5A827999, 0x6ED9EBA1, 0x8F1BBCDC, 0xA953FD4E,
	0x50A28BE6, 0x5C4DD124, 0x6D703EF3, 0x7A6D76E9, 0x00000000,
};

static void loop(const uint8_t *data, int i, uint32_t *tmp, int ofs)
{
	uint32_t f;

	if ((ofs ? 79 - i : i) <= 15)
		f = tmp[1] ^ tmp[2] ^ tmp[3];
	else if ((ofs ? 79 - i : i) <= 31)
		f = (tmp[1] & tmp[2]) | ((~tmp[1]) & tmp[3]);
	else if ((ofs ? 79 - i : i) <= 47)
		f = (tmp[1] | (~tmp[2])) ^ tmp[3];
	else if ((ofs ? 79 - i : i) <= 63)
		f = (tmp[1] & tmp[3]) | (tmp[2] & (~tmp[3]));
	else
		f = tmp[1] ^ (tmp[2] | (~tmp[3]));
	f += k[(ofs ? 80 + i : i) / 16];
	f += tmp[0];
	f += le32dec(&data[g[ofs ? 80 + i : i] * 4]);
	f = rol32(f, s[ofs ? 80 + i : i]) + tmp[4];
	tmp[0] = tmp[4];
	tmp[4] = tmp[3];
	tmp[3] = rol32(tmp[2], 10);
	tmp[2] = tmp[1];
	tmp[1] = f;
}

static void chunk(struct ripemd160_ctx *ctx, const uint8_t *data)
{
	uint32_t tmp[10];

	for (int i = 0; i < 5; ++i)
	{
		tmp[i + 0] = ctx->h[i];
		tmp[i + 5] = ctx->h[i];
	}
	for (int i = 0; i < 80; ++i)
	{
		loop(data, i, &tmp[0], 0);
		loop(data, i, &tmp[5], 1);
	}
	tmp[8] += ctx->h[1] + tmp[2];
	ctx->h[1] = ctx->h[2] + tmp[3] + tmp[9];
	ctx->h[2] = ctx->h[3] + tmp[4] + tmp[5];
	ctx->h[3] = ctx->h[4] + tmp[0] + tmp[6];
	ctx->h[4] = ctx->h[0] + tmp[1] + tmp[7];
	ctx->h[0] = tmp[8];
}

int ripemd160_init(struct ripemd160_ctx *ctx)
{
	ctx->total_size = 0;
	ctx->data_size = 0;
	ctx->h[0] = 0x67452301;
	ctx->h[1] = 0xEFCDAB89;
	ctx->h[2] = 0x98BADCFE;
	ctx->h[3] = 0x10325476;
	ctx->h[4] = 0xC3D2E1F0;
	return 1;
}

int ripemd160_update(struct ripemd160_ctx *ctx, const void *data, size_t size)
{
	HASH_BUFFERIZE(ctx, data, size, 64);
	return 1;
}

int ripemd160_final(uint8_t *md, struct ripemd160_ctx *ctx)
{
	MERKLE_DAMGARD_FINALIZE(ctx, 64, 0);
	for (int i = 0; i < 5; ++i)
		le32enc(&md[i * 4], ctx->h[i]);
	return 1;
}

int ripemd160(const uint8_t *data, size_t size, uint8_t *md)
{
	struct ripemd160_ctx ctx;
	if (!ripemd160_init(&ctx)
	 || !ripemd160_update(&ctx, data, size)
	 || !ripemd160_final(md, &ctx))
		return 0;
	return 1;
}
