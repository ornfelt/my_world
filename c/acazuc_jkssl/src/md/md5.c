#include "utils/utils.h"
#include "md/md.h"

#include <string.h>

static const uint32_t s[64] =
{
	0x07, 0x0C, 0x11, 0x16, 0x07, 0x0C, 0x11, 0x16,
	0x07, 0x0C, 0x11, 0x16, 0x07, 0x0C, 0x11, 0x16,
	0x05, 0x09, 0x0E, 0x14, 0x05, 0x09, 0x0E, 0x14,
	0x05, 0x09, 0x0E, 0x14, 0x05, 0x09, 0x0E, 0x14,
	0x04, 0x0B, 0x10, 0x17, 0x04, 0x0B, 0x10, 0x17,
	0x04, 0x0B, 0x10, 0x17, 0x04, 0x0B, 0x10, 0x17,
	0x06, 0x0A, 0x0F, 0x15, 0x06, 0x0A, 0x0F, 0x15,
	0x06, 0x0A, 0x0F, 0x15, 0x06, 0x0A, 0x0F, 0x15,
};

static const uint32_t g[64] =
{
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x01, 0x06, 0x0B, 0x00, 0x05, 0x0A, 0x0F, 0x04,
	0x09, 0x0E, 0x03, 0x08, 0x0D, 0x02, 0x07, 0x0C,
	0x05, 0x08, 0x0B, 0x0E, 0x01, 0x04, 0x07, 0x0A,
	0x0D, 0x00, 0x03, 0x06, 0x09, 0x0C, 0x0F, 0x02,
	0x00, 0x07, 0x0E, 0x05, 0x0C, 0x03, 0x0A, 0x01,
	0x08, 0x0F, 0x06, 0x0D, 0x04, 0x0B, 0x02, 0x09,
};

static const uint32_t k[64] =
{
	0xD76AA478, 0xE8C7B756, 0x242070DB, 0xC1BDCEEE,
	0xF57C0FAF, 0x4787C62A, 0xA8304613, 0xFD469501,
	0x698098D8, 0x8B44F7AF, 0xFFFF5BB1, 0x895CD7BE,
	0x6B901122, 0xFD987193, 0xA679438E, 0x49B40821,
	0xF61E2562, 0xC040B340, 0x265E5A51, 0xE9B6C7AA,
	0xD62F105D, 0x02441453, 0xD8A1E681, 0xE7D3FBC8,
	0x21E1CDE6, 0xC33707D6, 0xF4D50D87, 0x455A14ED,
	0xA9E3E905, 0xFCEFA3F8, 0x676F02D9, 0x8D2A4C8A,
	0xFFFA3942, 0x8771F681, 0x6D9D6122, 0xFDE5380C,
	0xA4BEEA44, 0x4BDECFA9, 0xF6BB4B60, 0xBEBFBC70,
	0x289B7EC6, 0xEAA127FA, 0xD4EF3085, 0x04881D05,
	0xD9D4D039, 0xE6DB99E5, 0x1FA27CF8, 0xC4AC5665,
	0xF4292244, 0x432AFF97, 0xAB9423A7, 0xFC93A039,
	0x655B59C3, 0x8F0CCC92, 0xFFEFF47D, 0x85845DD1,
	0x6FA87E4F, 0xFE2CE6E0, 0xA3014314, 0x4E0811A1,
	0xF7537E82, 0xBD3AF235, 0x2AD7D2BB, 0xEB86D391,
};

#define ROUND(data, i, tmp, fv) \
do \
{ \
	uint32_t f = (fv) + (tmp)[0] + k[(i)] + le32dec(&(data)[g[(i)] * 4]); \
	(tmp)[0] = (tmp)[3]; \
	(tmp)[3] = (tmp)[2]; \
	(tmp)[2] = (tmp)[1]; \
	(tmp)[1] += rol32(f, s[(i)]); \
} while (0)

#define ROUND1(data, i, tmp) ROUND(data, i, tmp, ((tmp)[1] & (tmp)[2]) | ((~(tmp)[1]) & (tmp)[3]))
#define ROUND2(data, i, tmp) ROUND(data, i, tmp, ((tmp)[3] & (tmp)[1]) | ((~(tmp)[3]) & (tmp)[2]))
#define ROUND3(data, i, tmp) ROUND(data, i, tmp, (tmp)[1] ^ (tmp)[2] ^ (tmp)[3])
#define ROUND4(data, i, tmp) ROUND(data, i, tmp, (tmp)[2] ^ ((tmp)[1] | (~(tmp)[3])))

static void chunk(struct md5_ctx *ctx, const uint8_t *data)
{
	uint32_t tmp[4];

	for (int i = 0; i < 4; ++i)
		tmp[i] = ctx->h[i];

	ROUND1(data, 0x00, tmp);
	ROUND1(data, 0x01, tmp);
	ROUND1(data, 0x02, tmp);
	ROUND1(data, 0x03, tmp);
	ROUND1(data, 0x04, tmp);
	ROUND1(data, 0x05, tmp);
	ROUND1(data, 0x06, tmp);
	ROUND1(data, 0x07, tmp);
	ROUND1(data, 0x08, tmp);
	ROUND1(data, 0x09, tmp);
	ROUND1(data, 0x0A, tmp);
	ROUND1(data, 0x0B, tmp);
	ROUND1(data, 0x0C, tmp);
	ROUND1(data, 0x0D, tmp);
	ROUND1(data, 0x0E, tmp);
	ROUND1(data, 0x0F, tmp);
	ROUND2(data, 0x10, tmp);
	ROUND2(data, 0x11, tmp);
	ROUND2(data, 0x12, tmp);
	ROUND2(data, 0x13, tmp);
	ROUND2(data, 0x14, tmp);
	ROUND2(data, 0x15, tmp);
	ROUND2(data, 0x16, tmp);
	ROUND2(data, 0x17, tmp);
	ROUND2(data, 0x18, tmp);
	ROUND2(data, 0x19, tmp);
	ROUND2(data, 0x1A, tmp);
	ROUND2(data, 0x1B, tmp);
	ROUND2(data, 0x1C, tmp);
	ROUND2(data, 0x1D, tmp);
	ROUND2(data, 0x1E, tmp);
	ROUND2(data, 0x1F, tmp);
	ROUND3(data, 0x20, tmp);
	ROUND3(data, 0x21, tmp);
	ROUND3(data, 0x22, tmp);
	ROUND3(data, 0x23, tmp);
	ROUND3(data, 0x24, tmp);
	ROUND3(data, 0x25, tmp);
	ROUND3(data, 0x26, tmp);
	ROUND3(data, 0x27, tmp);
	ROUND3(data, 0x28, tmp);
	ROUND3(data, 0x29, tmp);
	ROUND3(data, 0x2A, tmp);
	ROUND3(data, 0x2B, tmp);
	ROUND3(data, 0x2C, tmp);
	ROUND3(data, 0x2D, tmp);
	ROUND3(data, 0x2E, tmp);
	ROUND3(data, 0x2F, tmp);
	ROUND4(data, 0x30, tmp);
	ROUND4(data, 0x31, tmp);
	ROUND4(data, 0x32, tmp);
	ROUND4(data, 0x33, tmp);
	ROUND4(data, 0x34, tmp);
	ROUND4(data, 0x35, tmp);
	ROUND4(data, 0x36, tmp);
	ROUND4(data, 0x37, tmp);
	ROUND4(data, 0x38, tmp);
	ROUND4(data, 0x39, tmp);
	ROUND4(data, 0x3A, tmp);
	ROUND4(data, 0x3B, tmp);
	ROUND4(data, 0x3C, tmp);
	ROUND4(data, 0x3D, tmp);
	ROUND4(data, 0x3E, tmp);
	ROUND4(data, 0x3F, tmp);

	for (int i = 0; i < 4; ++i)
		ctx->h[i] += tmp[i];
}

int md5_init(struct md5_ctx *ctx)
{
	ctx->total_size = 0;
	ctx->data_size = 0;
	ctx->h[0] = 0x67452301;
	ctx->h[1] = 0xEFCDAB89;
	ctx->h[2] = 0x98BADCFE;
	ctx->h[3] = 0x10325476;
	return 1;
}

int md5_update(struct md5_ctx *ctx, const void *data, size_t size)
{
	HASH_BUFFERIZE(ctx, data, size, 64);
	return 1;
}

int md5_final(uint8_t *md, struct md5_ctx *ctx)
{
	MERKLE_DAMGARD_FINALIZE(ctx, 64, 0);
	for (int i = 0; i < 4; ++i)
		le32enc(&md[i * 4], ctx->h[i]);
	return 1;
}

int md5(const uint8_t *data, size_t size, uint8_t *md)
{
	struct md5_ctx ctx;
	if (!md5_init(&ctx)
	 || !md5_update(&ctx, data, size)
	 || !md5_final(md, &ctx))
		return 0;
	return 1;
}
