#include "utils/utils.h"
#include "des/des.h"

static const uint8_t rots[16] =
{
	1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1,
};

static const uint8_t pc1[56] =
{
	0x38, 0x30, 0x28, 0x20, 0x18, 0x10, 0x08, 0x00,
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09, 0x01,
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x3B, 0x33, 0x2B, 0x23, 0x3E, 0x36, 0x2E, 0x26,
	0x1E, 0x16, 0x0E, 0x06, 0x3D, 0x35, 0x2D, 0x25,
	0x1D, 0x15, 0x0D, 0x05, 0x3C, 0x34, 0x2C, 0x24,
	0x1C, 0x14, 0x0C, 0x04, 0x1B, 0x13, 0x0B, 0x03,
};

static const uint8_t pc2[48] =
{
	0x0D, 0x10, 0x0A, 0x17, 0x00, 0x04, 0x02, 0x1B,
	0x0E, 0x05, 0x14, 0x09, 0x16, 0x12, 0x0B, 0x03,
	0x19, 0x07, 0x0F, 0x06, 0x1A, 0x13, 0x0C, 0x01,
	0x28, 0x33, 0x1E, 0x24, 0x2E, 0x36, 0x1D, 0x27,
	0x32, 0x2C, 0x20, 0x2F, 0x2B, 0x30, 0x26, 0x37,
	0x21, 0x34, 0x2D, 0x29, 0x31, 0x23, 0x1C, 0x1F,
};

static const uint8_t ip[64] =
{
	0x39, 0x31, 0x29, 0x21, 0x19, 0x11, 0x09, 0x01,
	0x3B, 0x33, 0x2B, 0x23, 0x1B, 0x13, 0x0B, 0x03,
	0x3D, 0x35, 0x2D, 0x25, 0x1D, 0x15, 0x0D, 0x05,
	0x3F, 0x37, 0x2F, 0x27, 0x1F, 0x17, 0x0F, 0x07,
	0x38, 0x30, 0x28, 0x20, 0x18, 0x10, 0x08, 0x00,
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x3C, 0x34, 0x2C, 0x24, 0x1C, 0x14, 0x0C, 0x04,
	0x3E, 0x36, 0x2E, 0x26, 0x1E, 0x16, 0x0E, 0x06,
};

static const uint8_t ip1[64] =
{
	0x27, 0x07, 0x2F, 0x0F, 0x37, 0x17, 0x3F, 0x1F,
	0x26, 0x06, 0x2E, 0x0E, 0x36, 0x16, 0x3E, 0x1E,
	0x25, 0x05, 0x2D, 0x0D, 0x35, 0x15, 0x3D, 0x1D,
	0x24, 0x04, 0x2C, 0x0C, 0x34, 0x14, 0x3C, 0x1C,
	0x23, 0x03, 0x2B, 0x0B, 0x33, 0x13, 0x3B, 0x1B,
	0x22, 0x02, 0x2A, 0x0A, 0x32, 0x12, 0x3A, 0x1A,
	0x21, 0x01, 0x29, 0x09, 0x31, 0x11, 0x39, 0x19,
	0x20, 0x00, 0x28, 0x08, 0x30, 0x10, 0x38, 0x18,
};

static const uint8_t e[48] =
{
	0x1F, 0x00, 0x01, 0x02, 0x03, 0x04, 0x03, 0x04,
	0x05, 0x06, 0x07, 0x08, 0x07, 0x08, 0x09, 0x0A,
	0x0B, 0x0C, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10,
	0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x13, 0x14,
	0x15, 0x16, 0x17, 0x18, 0x17, 0x18, 0x19, 0x1A,
	0x1B, 0x1C, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x00,
};

static const uint8_t p[32] =
{
	0x0F, 0x06, 0x13, 0x14, 0x1C, 0x0B, 0x1B, 0x10,
	0x00, 0x0E, 0x16, 0x19, 0x04, 0x11, 0x1E, 0x09,
	0x01, 0x07, 0x17, 0x0D, 0x1F, 0x1A, 0x02, 0x08,
	0x12, 0x0C, 0x1D, 0x05, 0x15, 0x0A, 0x03, 0x18,
};

static const uint32_t ss[8][64] =
{
	{
		0xE0000000, 0x00000000, 0x40000000, 0xF0000000,
		0xD0000000, 0x70000000, 0x10000000, 0x40000000,
		0x20000000, 0xE0000000, 0xF0000000, 0x20000000,
		0xB0000000, 0xD0000000, 0x80000000, 0x10000000,
		0x30000000, 0xA0000000, 0xA0000000, 0x60000000,
		0x60000000, 0xC0000000, 0xC0000000, 0xB0000000,
		0x50000000, 0x90000000, 0x90000000, 0x50000000,
		0x00000000, 0x30000000, 0x70000000, 0x80000000,
		0x40000000, 0xF0000000, 0x10000000, 0xC0000000,
		0xE0000000, 0x80000000, 0x80000000, 0x20000000,
		0xD0000000, 0x40000000, 0x60000000, 0x90000000,
		0x20000000, 0x10000000, 0xB0000000, 0x70000000,
		0xF0000000, 0x50000000, 0xC0000000, 0xB0000000,
		0x90000000, 0x30000000, 0x70000000, 0xE0000000,
		0x30000000, 0xA0000000, 0xA0000000, 0x00000000,
		0x50000000, 0x60000000, 0x00000000, 0xD0000000,
	},
	{
		0x0F000000, 0x03000000, 0x01000000, 0x0D000000,
		0x08000000, 0x04000000, 0x0E000000, 0x07000000,
		0x06000000, 0x0F000000, 0x0B000000, 0x02000000,
		0x03000000, 0x08000000, 0x04000000, 0x0E000000,
		0x09000000, 0x0C000000, 0x07000000, 0x00000000,
		0x02000000, 0x01000000, 0x0D000000, 0x0A000000,
		0x0C000000, 0x06000000, 0x00000000, 0x09000000,
		0x05000000, 0x0B000000, 0x0A000000, 0x05000000,
		0x00000000, 0x0D000000, 0x0E000000, 0x08000000,
		0x07000000, 0x0A000000, 0x0B000000, 0x01000000,
		0x0A000000, 0x03000000, 0x04000000, 0x0F000000,
		0x0D000000, 0x04000000, 0x01000000, 0x02000000,
		0x05000000, 0x0B000000, 0x08000000, 0x06000000,
		0x0C000000, 0x07000000, 0x06000000, 0x0C000000,
		0x09000000, 0x00000000, 0x03000000, 0x05000000,
		0x02000000, 0x0E000000, 0x0F000000, 0x09000000,
	},
	{
		0x00A00000, 0x00D00000, 0x00000000, 0x00700000,
		0x00900000, 0x00000000, 0x00E00000, 0x00900000,
		0x00600000, 0x00300000, 0x00300000, 0x00400000,
		0x00F00000, 0x00600000, 0x00500000, 0x00A00000,
		0x00100000, 0x00200000, 0x00D00000, 0x00800000,
		0x00C00000, 0x00500000, 0x00700000, 0x00E00000,
		0x00B00000, 0x00C00000, 0x00400000, 0x00B00000,
		0x00200000, 0x00F00000, 0x00800000, 0x00100000,
		0x00D00000, 0x00100000, 0x00600000, 0x00A00000,
		0x00400000, 0x00D00000, 0x00900000, 0x00000000,
		0x00800000, 0x00600000, 0x00F00000, 0x00900000,
		0x00300000, 0x00800000, 0x00000000, 0x00700000,
		0x00B00000, 0x00400000, 0x00100000, 0x00F00000,
		0x00200000, 0x00E00000, 0x00C00000, 0x00300000,
		0x00500000, 0x00B00000, 0x00A00000, 0x00500000,
		0x00E00000, 0x00200000, 0x00700000, 0x00C00000,
	},
	{
		0x00070000, 0x000D0000, 0x000D0000, 0x00080000,
		0x000E0000, 0x000B0000, 0x00030000, 0x00050000,
		0x00000000, 0x00060000, 0x00060000, 0x000F0000,
		0x00090000, 0x00000000, 0x000A0000, 0x00030000,
		0x00010000, 0x00040000, 0x00020000, 0x00070000,
		0x00080000, 0x00020000, 0x00050000, 0x000C0000,
		0x000B0000, 0x00010000, 0x000C0000, 0x000A0000,
		0x00040000, 0x000E0000, 0x000F0000, 0x00090000,
		0x000A0000, 0x00030000, 0x00060000, 0x000F0000,
		0x00090000, 0x00000000, 0x00000000, 0x00060000,
		0x000C0000, 0x000A0000, 0x000B0000, 0x00010000,
		0x00070000, 0x000D0000, 0x000D0000, 0x00080000,
		0x000F0000, 0x00090000, 0x00010000, 0x00040000,
		0x00030000, 0x00050000, 0x000E0000, 0x000B0000,
		0x00050000, 0x000C0000, 0x00020000, 0x00070000,
		0x00080000, 0x00020000, 0x00040000, 0x000E0000,
	},
	{
		0x00002000, 0x0000E000, 0x0000C000, 0x0000B000,
		0x00004000, 0x00002000, 0x00001000, 0x0000C000,
		0x00007000, 0x00004000, 0x0000A000, 0x00007000,
		0x0000B000, 0x0000D000, 0x00006000, 0x00001000,
		0x00008000, 0x00005000, 0x00005000, 0x00000000,
		0x00003000, 0x0000F000, 0x0000F000, 0x0000A000,
		0x0000D000, 0x00003000, 0x00000000, 0x00009000,
		0x0000E000, 0x00008000, 0x00009000, 0x00006000,
		0x00004000, 0x0000B000, 0x00002000, 0x00008000,
		0x00001000, 0x0000C000, 0x0000B000, 0x00007000,
		0x0000A000, 0x00001000, 0x0000D000, 0x0000E000,
		0x00007000, 0x00002000, 0x00008000, 0x0000D000,
		0x0000F000, 0x00006000, 0x00009000, 0x0000F000,
		0x0000C000, 0x00000000, 0x00005000, 0x00009000,
		0x00006000, 0x0000A000, 0x00003000, 0x00004000,
		0x00000000, 0x00005000, 0x0000E000, 0x00003000,
	},
	{
		0x00000C00, 0x00000A00, 0x00000100, 0x00000F00,
		0x00000A00, 0x00000400, 0x00000F00, 0x00000200,
		0x00000900, 0x00000700, 0x00000200, 0x00000C00,
		0x00000600, 0x00000900, 0x00000800, 0x00000500,
		0x00000000, 0x00000600, 0x00000D00, 0x00000100,
		0x00000300, 0x00000D00, 0x00000400, 0x00000E00,
		0x00000E00, 0x00000000, 0x00000700, 0x00000B00,
		0x00000500, 0x00000300, 0x00000B00, 0x00000800,
		0x00000900, 0x00000400, 0x00000E00, 0x00000300,
		0x00000F00, 0x00000200, 0x00000500, 0x00000C00,
		0x00000200, 0x00000900, 0x00000800, 0x00000500,
		0x00000C00, 0x00000F00, 0x00000300, 0x00000A00,
		0x00000700, 0x00000B00, 0x00000000, 0x00000E00,
		0x00000400, 0x00000100, 0x00000A00, 0x00000700,
		0x00000100, 0x00000600, 0x00000D00, 0x00000000,
		0x00000B00, 0x00000800, 0x00000600, 0x00000D00,
	},
	{
		0x00000040, 0x000000D0, 0x000000B0, 0x00000000,
		0x00000020, 0x000000B0, 0x000000E0, 0x00000070,
		0x000000F0, 0x00000040, 0x00000000, 0x00000090,
		0x00000080, 0x00000010, 0x000000D0, 0x000000A0,
		0x00000030, 0x000000E0, 0x000000C0, 0x00000030,
		0x00000090, 0x00000050, 0x00000070, 0x000000C0,
		0x00000050, 0x00000020, 0x000000A0, 0x000000F0,
		0x00000060, 0x00000080, 0x00000010, 0x00000060,
		0x00000010, 0x00000060, 0x00000040, 0x000000B0,
		0x000000B0, 0x000000D0, 0x000000D0, 0x00000080,
		0x000000C0, 0x00000010, 0x00000030, 0x00000040,
		0x00000070, 0x000000A0, 0x000000E0, 0x00000070,
		0x000000A0, 0x00000090, 0x000000F0, 0x00000050,
		0x00000060, 0x00000000, 0x00000080, 0x000000F0,
		0x00000000, 0x000000E0, 0x00000050, 0x00000020,
		0x00000090, 0x00000030, 0x00000020, 0x000000C0,
	},
	{
		0x0000000D, 0x00000001, 0x00000002, 0x0000000F,
		0x00000008, 0x0000000D, 0x00000004, 0x00000008,
		0x00000006, 0x0000000A, 0x0000000F, 0x00000003,
		0x0000000B, 0x00000007, 0x00000001, 0x00000004,
		0x0000000A, 0x0000000C, 0x00000009, 0x00000005,
		0x00000003, 0x00000006, 0x0000000E, 0x0000000B,
		0x00000005, 0x00000000, 0x00000000, 0x0000000E,
		0x0000000C, 0x00000009, 0x00000007, 0x00000002,
		0x00000007, 0x00000002, 0x0000000B, 0x00000001,
		0x00000004, 0x0000000E, 0x00000001, 0x00000007,
		0x00000009, 0x00000004, 0x0000000C, 0x0000000A,
		0x0000000E, 0x00000008, 0x00000002, 0x0000000D,
		0x00000000, 0x0000000F, 0x00000006, 0x0000000C,
		0x0000000A, 0x00000009, 0x0000000D, 0x00000000,
		0x0000000F, 0x00000003, 0x00000003, 0x00000005,
		0x00000005, 0x00000006, 0x00000008, 0x0000000B,
	},
};

static uint64_t permute(uint64_t src, const uint8_t *table,
                        uint8_t out_len, uint8_t in_len)
{
	uint64_t result = 0;
	out_len--;
	in_len--;
	for (size_t i = 0; i <= out_len; ++i)
		result |= ((src >> (in_len - table[i])) & 1) << (out_len - i);
	return result;
}

void des_generate_keys(struct des_ctx *ctx, const uint8_t *key)
{
	uint32_t c[16];
	uint32_t d[16];
	uint64_t dst = permute(be64dec(key), pc1, 56, 64);
	c[0] = rol28((dst & 0xFFFFFFF0000000) >> 28, rots[0]);
	d[0] = rol28(dst & 0xFFFFFFF, rots[0]);
	for (size_t i = 1; i < 16; ++i)
	{
		c[i] = rol28(c[i - 1], rots[i]);
		d[i] = rol28(d[i - 1], rots[i]);
	}
	for (size_t i = 0; i < 16; ++i)
	{
		uint64_t tmp = (uint64_t)d[i] | ((uint64_t)c[i] << 28);
		ctx->keys[i] = permute(tmp, pc2, 48, 56);
	}
}

static uint32_t f(uint32_t r, uint64_t key)
{
	uint64_t tmp = permute(r, e, 48, 32);
	tmp ^= key;
	uint32_t res = 0;
	for (size_t i = 0; i < 8; ++i)
		res |= ss[i][(tmp >> (6 * (7 - i))) & 0x3F];
	return permute(res, p, 32, 32);
}

void des_operate_block(struct des_ctx *ctx, uint8_t *out, const uint8_t *in,
                       int enc)
{
	uint32_t l[16];
	uint32_t r[16];
	uint64_t tmp = be64dec(in);
	tmp = permute(tmp, ip, 64, 64);
	l[0] = tmp;
	r[0] = (tmp >> 32) ^ f(l[0], ctx->keys[enc ? 0 : 15]);
	for (size_t i = 1; i < 16; ++i)
	{
		l[i] = r[i - 1];
		r[i] = l[i - 1] ^ f(r[i - 1], ctx->keys[enc ? i : 15 - i]);
	}
	tmp = ((uint64_t)r[15] << 32) | (uint64_t)l[15];
	be64enc(out, permute(tmp, ip1, 64, 64));
}
